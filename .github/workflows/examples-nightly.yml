name: Examples Validation (Nightly)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main
    paths:
      - "examples/**"
      - "demonstrations/**"
      - "demos/**"
      - "tests/integration/test_examples.py"

# Explicit permissions for security
permissions:
  contents: read # Read repository contents
  issues: write # Create issues on nightly failures

jobs:
  validate-examples:
    name: Validate Examples
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ matrix.python-version }}

      - name: Generate demo data
        run: |
          # Generate any required demo data files
          if [ -f "demos/generate_all_demo_data.py" ]; then
            uv run python demos/generate_all_demo_data.py
          fi

      - name: Run example validation tests
        run: |
          uv run pytest tests/integration/test_examples.py \
            -v \
            --tb=short \
            --durations=20 \
            --timeout=120
        continue-on-error: false

      - name: Create issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Nightly Examples Validation Failed';
            const body = `
            ## Examples Validation Failure

            The nightly examples validation failed on Python ${{ matrix.python-version }}.

            **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Branch**: ${{ github.ref }}
            **Commit**: ${{ github.sha }}

            Please investigate and fix the failing examples.
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['examples', 'nightly-failure']
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['examples', 'nightly-failure', 'automated']
              });
            }
